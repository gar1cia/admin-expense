<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#01017C" />
  <title>Archer Civil Construction LLC – Expense Submission</title>

  <style>
    :root{
      /* Pulled from Archer logo */
      --archer-blue: #01017C;
      --archer-gray: #7A7A7D;

      --bg: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: rgba(1,1,124,.20);
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      --radius: 16px;

      --tap: 52px;
      --pad: 14px;
    }

    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.25;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    .wrap{
      max-width: 560px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    .brand{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin: 10px 0 14px;
    }

    .logo{
      width: min(420px, 92vw);
      height: auto;
      display:block;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      background: #fff;
    }

    .title{
      font-size: 1.15rem;
      color: var(--archer-blue);
      margin: 0 0 6px;
    }

    .subtitle{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: .95rem;
    }

    .grid{
      display:grid;
      gap: 12px;
    }

    label{
      display:block;
      font-size: .92rem;
      margin: 0 0 6px;
      color: var(--text);
    }

    .hint{
      display:block;
      margin-top: 6px;
      color: var(--muted);
      font-size: .86rem;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea{
      width: 100%;
      height: var(--tap);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 0 var(--pad);
      font-size: 1rem;
      background: #fff;
      color: var(--text);
      outline: none;
    }

    textarea{
      min-height: 92px;
      height: auto;
      padding: 12px var(--pad);
      resize: vertical;
    }

    input[type="number"]{ appearance: textfield; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(1,1,124,.55);
      box-shadow: 0 0 0 4px rgba(1,1,124,.12);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    .requiredTag{
      display:inline-block;
      margin-left: 8px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .75rem;
      color: var(--archer-blue);
      border: 1px solid rgba(1,1,124,.28);
      background: rgba(1,1,124,.06);
      vertical-align: middle;
    }

    /* Receipt capture */
    .photoBox{
      border: 1px dashed rgba(1,1,124,.35);
      border-radius: 14px;
      padding: 12px;
      background: rgba(1,1,124,.03);
    }

    .photoActions{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn{
      height: var(--tap);
      border-radius: 14px;
      border: 1px solid rgba(1,1,124,.35);
      padding: 0 14px;
      font-size: 1rem;
      cursor: pointer;
      background: #fff;
      color: var(--archer-blue);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: var(--archer-blue);
      border-color: var(--archer-blue);
      color: #fff;
      width: 100%;
      font-weight: 600;
    }

    .btnGhost{
      background: #fff;
      color: var(--archer-blue);
    }

    .pillGroup{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pill{
      border: 1px solid rgba(1,1,124,.35);
      background: #fff;
      color: var(--archer-blue);
      height: 46px;
      padding: 0 12px;
      border-radius: 999px;
      font-size: .98rem;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill[aria-pressed="true"]{
      background: rgba(1,1,124,.10);
      border-color: rgba(1,1,124,.70);
      box-shadow: 0 0 0 4px rgba(1,1,124,.10);
    }

    .preview{
      margin-top: 10px;
      display:none;
    }
    .preview img{
      width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#fff;
    }

    .error{
      display:none;
      border-left: 4px solid #b91c1c;
      background: #fef2f2;
      color: #7f1d1d;
      padding: 10px 12px;
      border-radius: 12px;
      margin: 10px 0 0;
      font-size: .95rem;
    }

    .success{
      display:none;
      text-align:center;
      padding: 20px 12px;
    }
    .check{
      width: 62px;
      height: 62px;
      border-radius: 999px;
      margin: 0 auto 10px;
      background: rgba(1,1,124,.10);
      border: 1px solid rgba(1,1,124,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--archer-blue);
      font-size: 34px;
    }

    .fineprint{
      margin-top: 10px;
      color: var(--archer-gray);
      font-size: .86rem;
      text-align: center;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="brand" aria-label="Archer Civil Construction LLC">
      <!-- Put archer_logo.png in the same folder as this HTML, or update the src to your hosted path -->
      <img class="logo" src="archer_logo.png" alt="Archer Civil Construction LLC logo">
    </section>

    <section class="card" id="formCard">
      <p class="title"><strong>Expense submission</strong></p>
      <p class="subtitle">Take a receipt photo, pick a few items, and submit.</p>

      <form id="expenseForm" class="grid" novalidate>
        <!-- Receipt Photo -->
        <div class="photoBox">
          <label for="receipt">
            Receipt photo <span class="requiredTag">Required</span>
          </label>

          <div class="photoActions">
            <button type="button" class="btn btnGhost" id="takePhotoBtn">Take / Choose photo</button>
            <span class="hint">On iPhone, this opens the camera. On Android, camera or gallery.</span>
          </div>

          <input
            id="receipt"
            name="receipt"
            type="file"
            accept="image/*"
            capture="environment"
            class="hidden"
            required
          />

          <div class="preview" id="preview">
            <img id="previewImg" alt="Receipt preview">
          </div>
        </div>

        <!-- Project + Category -->
        <div class="row">
          <div>
            <label for="project">
              Project <span class="requiredTag">Required</span>
            </label>
            <select id="project" name="project" required>
              <option value="" selected disabled>Select a project</option>
              <!-- Keep this list short (Active Projects). Add/edit as needed. -->
              <option value="Office / Non-Job">Office / Non-Job</option>
              <option value="06-1G7404 SR-63/65 Rumble Strips">06-1G7404 SR-63/65 Rumble Strips</option>
              <option value="06-1G8404 Tipton">06-1G8404 Tipton</option>
              <option value="Road 64 Improvements">Road 64 Improvements</option>
              <option value="Other">Other</option>
            </select>
            <input id="projectOther" name="projectOther" type="text" placeholder="Enter project name" class="hidden" />
          </div>

          <div>
            <label for="category">
              Category <span class="requiredTag">Required</span>
            </label>
            <select id="category" name="category" required>
              <option value="" selected disabled>Select a category</option>
              <option value="Fuel">Fuel</option>
              <option value="Meals">Meals</option>
              <option value="Parts">Parts</option>
              <option value="Lodging">Lodging</option>
              <option value="Supplies">Supplies</option>
              <option value="Tools">Tools</option>
              <option value="Equipment Rental">Equipment Rental</option>
              <option value="Misc">Misc</option>
            </select>
          </div>
        </div>

        <!-- Vendor -->
        <div>
          <label for="vendor">
            Vendor <span class="requiredTag">Required</span>
          </label>
          <select id="vendor" name="vendor" required>
            <option value="" selected disabled>Select a vendor</option>
            <option value="Fuel Station">Fuel Station</option>
            <option value="Restaurant">Restaurant</option>
            <option value="Parts Supplier">Parts Supplier</option>
            <option value="Hardware Store">Hardware Store</option>
            <option value="Hotel">Hotel</option>
            <option value="Rental Company">Rental Company</option>
            <option value="Other">Other</option>
          </select>
          <input id="vendorOther" name="vendorOther" type="text" placeholder="Enter vendor name" class="hidden" />
        </div>

        <!-- Amount + Date -->
        <div class="row">
          <div>
            <label for="amount">
              Amount <span class="requiredTag">Required</span>
            </label>
            <input id="amount" name="amount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 47.82" required />
          </div>

          <div>
            <label for="expenseDate">
              Expense date <span class="requiredTag">Required</span>
            </label>
            <input id="expenseDate" name="expenseDate" type="date" required />
          </div>
        </div>

        <!-- Payment Method -->
        <div>
          <label>
            Payment method <span class="requiredTag">Required</span>
          </label>
          <div class="pillGroup" role="group" aria-label="Payment method">
            <button type="button" class="pill" data-pay="Company Card" aria-pressed="false">Company card</button>
            <button type="button" class="pill" data-pay="Personal Card" aria-pressed="false">Personal card</button>
            <button type="button" class="pill" data-pay="Cash" aria-pressed="false">Cash</button>
            <button type="button" class="pill" data-pay="Other" aria-pressed="false">Other</button>
          </div>
          <input id="paymentMethod" name="paymentMethod" type="text" class="hidden" required />
          <input id="paymentOther" name="paymentOther" type="text" placeholder="Enter payment details" class="hidden" />
        </div>

        <!-- Optional fields -->
        <div>
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" placeholder="Optional: cost code, reason, who approved, etc."></textarea>
        </div>

        <!-- Hidden autofill fields -->
        <input type="hidden" id="submittedBy" name="submittedBy" value="" />
        <input type="hidden" id="source" name="source" value="qr-html" />

        <!-- Error -->
        <div class="error" id="errorBox" role="alert"></div>

        <!-- Submit -->
        <button type="submit" class="btn btnPrimary" id="submitBtn">Submit</button>

        <div class="fineprint">
          Archer Civil Construction LLC
        </div>
      </form>

      <!-- Success screen -->
      <div class="success" id="successBox" aria-live="polite">
        <div class="check">✔</div>
        <p class="title"><strong>Expense submitted</strong></p>
        <p class="subtitle">Thanks — you’re done.</p>
        <button type="button" class="btn btnGhost" id="submitAnotherBtn">Submit another</button>
      </div>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
    // Replace with your real serverless endpoint in Step 3
    const SUBMIT_ENDPOINT = "https://expense-intake-backend.vercel.app/api/submit-expense";

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || "";
    }

    function setError(msg){
      const box = $("errorBox");
      box.textContent = msg;
      box.style.display = "block";
      box.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    function clearError(){
      const box = $("errorBox");
      box.textContent = "";
      box.style.display = "none";
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // ====== INIT ======
    (function init(){
      // Default date to today
      $("expenseDate").value = todayISO();

      // Autofill from URL params (supports project + user)
      // Example QR URL: https://yourdomain.com/expense.html?project=06-1G8404%20Tipton&user=JG
      const projectParam = getParam("project");
      const userParam = getParam("user");

      if (userParam) $("submittedBy").value = userParam;

      if (projectParam){
        // If the project exists in the dropdown, select it and lock the control.
        const projectSelect = $("project");
        const optionExists = Array.from(projectSelect.options).some(o => o.value === projectParam);

        if (optionExists){
          projectSelect.value = projectParam;
          projectSelect.disabled = true;
        } else {
          projectSelect.value = "Other";
          $("projectOther").classList.remove("hidden");
          $("projectOther").value = projectParam;
        }
      }
    })();

    // ====== RECEIPT PHOTO ======
    $("takePhotoBtn").addEventListener("click", () => $("receipt").click());

    $("receipt").addEventListener("change", () => {
      clearError();
      const file = $("receipt").files && $("receipt").files[0];
      if (!file) return;

      // Preview
      const url = URL.createObjectURL(file);
      $("previewImg").src = url;
      $("preview").style.display = "block";
    });

    // ====== OTHER FIELDS LOGIC ======
    $("vendor").addEventListener("change", () => {
      const isOther = $("vendor").value === "Other";
      $("vendorOther").classList.toggle("hidden", !isOther);
      if (!isOther) $("vendorOther").value = "";
    });

    $("project").addEventListener("change", () => {
      const isOther = $("project").value === "Other";
      $("projectOther").classList.toggle("hidden", !isOther);
      if (!isOther) $("projectOther").value = "";
    });

    // Payment pills
    document.querySelectorAll(".pill[data-pay]").forEach(btn => {
      btn.addEventListener("click", () => {
        clearError();

        // Toggle pressed state (single-select)
        document.querySelectorAll(".pill[data-pay]").forEach(b => b.setAttribute("aria-pressed", "false"));
        btn.setAttribute("aria-pressed", "true");

        const value = btn.getAttribute("data-pay");
        $("paymentMethod").value = value;
        $("paymentMethod").classList.add("hidden"); // remains hidden but filled

        const isOther = value === "Other";
        $("paymentOther").classList.toggle("hidden", !isOther);
        if (!isOther) $("paymentOther").value = "";
      });
    });

    // ====== VALIDATION ======
    function validate(){
      clearError();

      const receipt = $("receipt").files && $("receipt").files[0];
      if (!receipt) return "Please add a receipt photo to continue.";

      const project = $("project").disabled ? $("project").value : $("project").value;
      if (!project) return "Please select a project.";

      if (project === "Other" && !$("projectOther").value.trim()){
        return "Please enter the project name.";
      }

      const category = $("category").value;
      if (!category) return "Please select a category.";

      const vendor = $("vendor").value;
      if (!vendor) return "Please select a vendor.";

      if (vendor === "Other" && !$("vendorOther").value.trim()){
        return "Please enter the vendor name.";
      }

      const amount = $("amount").value;
      if (!amount || Number(amount) <= 0) return "Please enter the amount.";

      const expenseDate = $("expenseDate").value;
      if (!expenseDate) return "Please enter the expense date.";

      const pay = $("paymentMethod").value.trim();
      if (!pay) return "Please select a payment method.";

      if (pay === "Other" && !$("paymentOther").value.trim()){
        return "Please enter the payment method details.";
      }

      return "";
    }

    // ====== SUBMIT ======
    $("expenseForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const err = validate();
      if (err){
        setError(err);
        return;
      }

      $("submitBtn").disabled = true;
      $("submitBtn").textContent = "Submitting…";

      try{
        const receiptFile = $("receipt").files[0];

        // Prepare payload as multipart/form-data so the backend can receive the image
        const fd = new FormData();
        fd.append("receipt", receiptFile);

        // Normalize fields
        const projectValue = $("project").disabled ? $("project").value : $("project").value;
        const projectFinal = (projectValue === "Other") ? $("projectOther").value.trim() : projectValue;

        const vendorValue = $("vendor").value;
        const vendorFinal = (vendorValue === "Other") ? $("vendorOther").value.trim() : vendorValue;

        const paymentValue = $("paymentMethod").value;
        const paymentFinal = (paymentValue === "Other") ? $("paymentOther").value.trim() : paymentValue;

        fd.append("project", projectFinal);
        fd.append("category", $("category").value);
        fd.append("vendor", vendorFinal);
        fd.append("amount", $("amount").value);
        fd.append("expenseDate", $("expenseDate").value);
        fd.append("paymentMethod", paymentFinal);
        fd.append("notes", $("notes").value || "");
        fd.append("submittedBy", $("submittedBy").value || "");
        fd.append("source", $("source").value);

        // POST to your serverless endpoint (Step 3 will write to Notion)
        const res = await fetch(SUBMIT_ENDPOINT, {
          method: "POST",
          body: fd
        });

        if (!res.ok){
          let msg = "Submission failed. Please try again.";
          try{
            const data = await res.json();
            if (data && data.error) msg = data.error;
          }catch(_){}
          throw new Error(msg);
        }

        // Success UI
        $("expenseForm").classList.add("hidden");
        $("successBox").style.display = "block";

      }catch(ex){
        setError(ex.message || "Submission failed. Please try again.");
      }finally{
        $("submitBtn").disabled = false;
        $("submitBtn").textContent = "Submit";
      }
    });

    // Submit another
    $("submitAnotherBtn").addEventListener("click", () => {
      // Reset form but keep project if locked via QR
      const lockedProject = $("project").disabled ? $("project").value : "";

      $("expenseForm").reset();
      clearError();
      $("preview").style.display = "none";
      $("successBox").style.display = "none";
      $("expenseForm").classList.remove("hidden");

      // Reset payment pills
      document.querySelectorAll(".pill[data-pay]").forEach(b => b.setAttribute("aria-pressed", "false"));
      $("paymentMethod").value = "";
      $("paymentOther").classList.add("hidden");
      $("vendorOther").classList.add("hidden");
      $("projectOther").classList.add("hidden");

      $("expenseDate").value = todayISO();

      if (lockedProject){
        $("project").value = lockedProject;
      }
    });
  </script>
</body>
</html>
